services:
  # Python ML Microservice (internal only)
  ml-service:
    build:
      context: ./ml_service
      dockerfile: Dockerfile
    container_name: ml-service
    restart: unless-stopped
    ports:
      - "5001:5000"  # External:Internal (5001 to avoid macOS AirPlay on 5000)
    volumes:
      - ./data/clean:/app/data/clean:ro
      - ./models:/app/models:ro
    environment:
      - FLASK_ENV=production
      - PORT=5000  # Internal port inside container
      - MODEL_BASE_PATH=/app/data/clean  # Path to housing model
      - ELECTRICITY_MODEL_PATH=/app/models/best_electricity_model_fast.pkl
      - PYTHONUNBUFFERED=1
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1400M
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - backend

  # Go API Gateway (public-facing)
  api-gateway:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: api-gateway
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - ML_SERVICE_URL=http://ml-service:5000
      - GIN_MODE=release
    depends_on:
      - ml-service
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    networks:
      - backend
      - frontend

  # Housing Price Predictor Frontend
  housing-app:
    build:
      context: .
      dockerfile: Dockerfile.housing
    container_name: housing-app
    restart: unless-stopped
    ports:
      - "8501:8501"
    volumes:
      - ./data/clean:/app/data/clean:ro
    environment:
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - frontend

  # Electricity Demand Predictor Frontend (optional)
  electricity-app:
    build:
      context: .
      dockerfile: Dockerfile.electricity
    container_name: electricity-app
    ports:
      - "8502:8502"
    volumes:
      - ./data/clean:/app/data/clean:ro
      - ./models:/app/models:ro
    networks:
      - frontend
    depends_on:
      - ml-service
    restart: unless-stopped

  # Nginx Reverse Proxy (optional - for production)
  # nginx:
  #   image: nginx:alpine
  #   container_name: nginx-proxy
  #   restart: unless-stopped
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./ssl:/etc/nginx/ssl:ro
  #   depends_on:
  #     - api-gateway
  #     - housing-app
  #   networks:
  #     - frontend

networks:
  backend:
    driver: bridge
  frontend:
    driver: bridge

volumes:
  models:
    driver: local
